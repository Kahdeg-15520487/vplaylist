<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>vPlaylist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.2/css/bulma.min.css" integrity="sha512-byErQdWdTqREz6DLAA9pCnLbdoGGhXfU6gm1c8bkf7F51JVmUBlayGe2A31VpXWQP+eiJ3ilTAZHCR3vmMyybA==" crossorigin="anonymous" />
    <style>
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        #footer, #transport {
            margin: 0;
        }
        #footer {
            padding: 0.5rem 1rem 0.5rem;
        }
        #transport > ion-icon {
            font-size: 36px;
            cursor: pointer;
            margin: 0 0.2rem;
        }
        #app-info {
            text-align: right;
        }
        th > div {
            display: flex;
            align-items: center;
        }
        th > div > ion-icon {
            font-size: 18px;
            cursor: pointer;
            margin-right: 1rem;
        }
        td > img {
            height: 4rem;
        }
    </style>
</head>
<body>
    <div class="level">
        <canvas width="640" height="360" style="width: 300px; background: #888"></canvas>
        <table class="table">
            <thead>
                <ion-icon name="reorder-two-outline" style="display:none"></ion-icon>
                <ion-icon name="caret-down-outline" style="display:none"></ion-icon>
                <ion-icon name="caret-up-outline" style="display:none"></ion-icon>
                <tr id="list-header"></tr>
            </thead>
            <tbody></tbody>
        </table>
        <template id="list-header-item">
            <th>
                <div>
                    <ion-icon name="reorder-two-outline"></ion-icon>
                </div>
            </th>
        </template>
        <template id="list-item">
            <tr>
                <td style="min-width: 7.2rem"><img src=""></td>
            </tr>
        </template>
    </div>
    <footer class="level has-background-dark has-text-light" id="footer">
        <div id="media-info" class="level-left media">
        </div>
        <div id="transport" class="level-item level">
            <ion-icon name="play-skip-back"></ion-icon>
            <ion-icon name="play-circle"></ion-icon>
            <ion-icon name="pause-circle" style="display:none"></ion-icon>
            <ion-icon name="play-skip-forward"></ion-icon>
            <ion-icon name="shuffle"></ion-icon>
        </div>
        <div id="app-info" class="level-right">
            <div class="container">
                <p>vPlaylist 1.0</p>
                <p>Channel: <span id="channel-id"></span></p>
            </div>
        </div>
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.4.0/ionicons.min.js" integrity="sha512-esqkwbZWQWGPKMg0apElthYF54n7TMcMGQs/rC8KyWIjuFt+d+kB2n4j7yWOXGn82wMrs5rLMPoiw7n73GJ5Nw==" crossorigin="anonymous"></script>
    <script>
        let headers = [];
        let flatPlaylst = [];

        function render() {
            const header = document.querySelector("#list-header");
            const tbody = document.querySelector("tbody");
            header.innerHTML = "";
            tbody.innerHTML = "";

            const headerItem = document.querySelector("#list-header-item");
            header.appendChild(document.createElement("th"));
            for(let headerText of headers) {
                const entry = headerItem.content.cloneNode(true);
                entry.querySelector("div").appendChild(document.createTextNode(headerText));
                header.appendChild(entry);
            }

            const listItem = document.querySelector("#list-item");
            for(let { v, ss, t, meta } of flatPlaylst) {
                const entry = listItem.content.cloneNode(true);
                entry.querySelector("img").src = `https://img.youtube.com/vi/${v}/sddefault.jpg`;
                const tr = entry.querySelector("tr");
                for(let k of headers) {
                     const td = document.createElement("td"); 
                    td.textContent = meta[k];
                    tr.appendChild(td);
                }
                tbody.appendChild(entry);
            }
        }

        function sort(headerIdx) {
            const k = headers[headerIdx];
            flatPlaylst.sort((a,b) => a.meta[k].localeCompare(b.meta[k]));
            render();
        }
        
        async function connect(channel) {
            document.querySelector("#channel-id").textContent = channel;
            try {
                const resp = await fetch(`https://vplaylist.herokuapp.com/${channel}`);
                if(!resp.ok) throw Error(resp.statusText);
                const playlist = await resp.json();
                
                flatPlaylst = [];
                const metaHeader = new Set();
                for(let { v, ts, ... videoMeta } of playlist) {
                    for(let { ss, t, ... trackMeta } of ts) {
                        const meta = { ... videoMeta, ... trackMeta };
                        Object.keys(meta).forEach(h => metaHeader.add(h));
                        flatPlaylst.push({ v, ss, t, meta });
                    }
                }
                
                headers = Array.from(metaHeader).sort((a,b) => a.localeCompare(b));
                render();
            } catch(err) {
                console.warn(err);
            }
        }

        connect("811277119991709719");
    </script>
</body>
</html>
